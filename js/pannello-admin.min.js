var campiDati={},scanner=null;function aggiungiListenerBottoneDisponibilita(){$("#tabella-giorni button").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$("#"+a+" td").first().text(),i=$("#"+a);$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Ripristinare i posti disponibili a 50 per il giorno"+e+"?",buttons:{Procedi:{action:function(){$.post("pannello_admin.php",{Disponibilita:1,Elimina:1,data:e},function(t){try{"1"==(t=JSON.parse(t)).stato?(generaAlert("green","Successo",t.messaggio),i.remove()):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})})}function togliListenerBottoneDisponibilita(){$("#tabella-giorni button").off("click")}function eliminaRigaTabella(t){$("#"+t).slideUp("Slow",function(){$("#"+t).remove()})}function rispostaEliminiazionePrenotazione(t){eliminaRigaTabella(t)}function salvaDati(t){var a=$("#"+t).find("input[type=text], textarea,input[type=number]"),e={};return $(a).each(function(){e[$(this).attr("class")]=$(this).val()}),e}function validaFormModifica(t){var a=!0,e=$("#"+t),i=e.find(".alert.errore"),o=e.find("form"),n=e.find("textarea,input[type=text]");return pulisciErrori(i,o),$(n).each(function(){0==$(this).val().trim().length&&(notificaErrore($(this),"Il campo  "+$(this).attr("name")+"  non può essere vuoto",i,o),a=!1)}),a}function aggiugngiEventiSchedeAttivita(){$("[data-modifica=false]").find(" input[type=number],input[type=text], textarea").attr("disabled","disabled"),$(".elimina-attivita").on("click",function(){var t=$(this).attr("data-target");$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione dell'attività? Tutte le prenotazioni relative a questa attività verrannò eliminate ",buttons:{Procedi:{btnClass:"btn-red",action:function(){$.post("php/modifica_attivita.php",{eliminaAttivita:1,idAttivita:t},function(a){try{"1"==(a=JSON.parse(a)).stato?(generaAlert("green","Successo",a.messaggio),sistemaSchede(t),$("[data-attivita='"+t.replace("attivita-","")+"']").remove()):generaAlert("red","Errore",a.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})}),$(".schede .modifica").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");$("#"+a).attr("data-modifica","true"),abilitaModicaScheda(a),campiDati[a]=salvaDati(a)}),$(".schede .bottone-annulla").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).parent().parent(),e=a.parent().find(".alert.errore");pulisciErrori(e,a);var i=$(this).attr("data-target");$("#"+i).attr("data-modifica","false"),$("#nome-"+i).val(campiDati[i]["nome-attivita"]),$("#descrizione-"+i).val(campiDati[i].descrizione),$("#prezzo-"+i).val(""+campiDati[i].prezzo),disabilitaModificaScheda(i)}),$(".salva-dati").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");if(validaFormModifica(a)){var e=$("#"+a).find("form").serializeArray();e.push({name:"idAttivita",value:a}),$.post("php/modifica_attivita.php",e,function(t){try{1==(t=JSON.parse(t)).stato?(campiDati[a]=salvaDati(a),generaAlert("green","Successo",t.messaggio),disabilitaModificaScheda(a),$("#"+a+" h2").text(e[0].value)):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}})}function abilitaModicaScheda(t){$("#"+t).find("textarea,input[type=text],input[type=number]").removeAttr("disabled"),$("#"+t+" .salva-dati").show(),$("#"+t+" .bottone-annulla").show(),$("#"+t+" .modifica").hide(),$("#"+t+" .nome-attivita").focus()}function disabilitaModificaScheda(t){$("#"+t).find("textarea,input[type=text],input[type=number]").attr("disabled","disabled"),$("#"+t+" .salva-dati").hide(),$("#"+t+" .bottone-annulla").hide(),$("#"+t+" .modifica").show()}function togliEventiSchedeAttivita(){$(".elimina-attivita").off("click"),$(".salva-dati").off("click"),$(".schede .modifica").off("click"),$(".schede .bottone-annulla").off("click")}function fadeDialogoNuovaAttivita(){$("#nuova-scheda-attivita").fadeOut("Slow",function(){$("#nuova-attivita").find("input[type=text],textarea,input[type=number]").val(""),$("#nuova-attivita h2 span").remove(),sbloccaScroll()})}function aggiungiEventiMacroAttivita(){$(".btn-nuova-attivita").on("click",function(){var t=$(this).attr("data-info"),a=$(this).attr("data-target");$("#nuova-attivita h2").prepend("<span>"+t+" - </span>"),$("#nuova-attivita input[type=submit]").attr("data-macro",a),$("#nuova-scheda-attivita").show(),bloccaScroll(),$("#nome").focus()}),$("#nuova-attivita button").on("click",function(t){t.preventDefault(),t.stopPropagation(),pulisciErrori($("#nuova-attivita").find(".alert.errore"),$("#nuova-attivita").find("form")),fadeDialogoNuovaAttivita()}),$("#nuova-attivita input[type=submit]").on("click",function(t){t.preventDefault(),t.stopPropagation();$(this).next("div");if(validaFormModifica("nuova-attivita")){var a=$(this).attr("data-macro"),e=$("#nuova-attivita form").serializeArray();e.push({name:"nuovaAttivita",value:"true"},{name:"idMacro",value:a}),$.post("php/modifica_attivita.php",e,function(t){try{if(1==(t=JSON.parse(t)).stato){var a=$("#gruppo-macro-"+t.idMacro+" .scheda-wrapper").length%2,e="";e=0==a?"pari":"dispari",$.alert({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,type:"green",title:"Successo",content:t.messaggio,buttons:{Ok:{action:function(){$.post("pannello_admin.php",{nuovaScheda:1,Classe:e,Codice:t.CodiceAtt},function(a){$(a).insertBefore($("#gruppo-macro-"+t.idMacro+" .inserimento-scheda")),togliEventiSchedeAttivita(),fadeDialogoNuovaAttivita(),aggiugngiEventiSchedeAttivita()})}}}})}else t.hasOwnProperty("Tipo")?notificaErrore($("#nuova-attivita #nome"),t.messaggio,$("#nuova-attivita .alert.errore"),$("#nuova-attivita")):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}}),$(".mod-macro").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).parent().attr("data-target");$.post("pannello_admin.php",{RichiestaMacro:a},function(t){try{t=JSON.parse(t),$("#label-dialog2").text(t.Nome+" - Modifica"),$("#nome-macro").val(t.Nome),$("#descrizione-macro").val($("<textarea/>").html(t.Descrizione).text()),$("#finestra-macro").show(),bloccaScroll(),$("#finestra-macro input[type=submit]").attr("data-fun",a)}catch(t){generaAlertErroreGenerico()}})}),$(".canc-macro").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).parent().attr("data-target"),e=$(this).parent().parent();$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione della macroattività? Tutte le attività relative ad essa verrannò eliminate e conseguentemente verranno eliminate le prenotazioni di queste ultime  ",buttons:{Procedi:{btnClass:"btn-red",action:function(){$.post("php/macroattivita.php",{idMacro:a,eliminaMacro:1},function(t){try{if("1"==(t=JSON.parse(t)).stato)generaAlert("green","Successo",t.messaggio),$("#gruppo-"+a).find("div.schede-attivita").each(function(){$("[data-attivita='"+$(this).attr("id").replace("attivita-","")+"']").remove()}),$("#gruppo-"+a).remove(),e.next().remove(),e.remove();else generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})})}function togliEventiMacroAttivita(){$(".btn-nuova-attivita").off("click"),$("#nuova-attivita button").off("click"),$("#nuova-attivita input[type=submit]").off("click"),$(".mod-macro").off("click"),$(".canc-macro").off("click")}function bloccaScroll(){$("body").css({overflow:"hidden"})}function sbloccaScroll(){$("body").css({"overflow-y":"scroll"})}function convalidaPrenotazione(t){$.post("pannello_admin.php",{convalidaPrenotazione:!0,prenotazione:t},function(a){try{var e=JSON.parse(a);1==e.stato?(generaAlert("green","Successo",e.messaggio),$("tr#"+t.split("-")[1]+" > td.stato").text("Confermata"),$("form#convalidaQR")[0].reset()):generaAlert("red","Errore",e.messaggio)}catch(t){generaAlertErroreGenerico()}})}$(function(){aggiungiEventiMacroAttivita(),aggiugngiEventiSchedeAttivita(),$("#crea-macro").on("click",function(){$("#label-dialog2").text("Nuova macroattività"),$("#finestra-macro").show(),bloccaScroll(),$("#finestra-macro input[type=submit]").attr("data-fun","0")}),$("#finestra-macro input[type=submit]").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-fun");if(validaFormModifica("finestra-macro")){$("#finestra-macro form");var e=new FormData;if(e.append("nome-macro",$("#nome-macro").val()),e.append("descrizione-macro",$("#descrizione-macro").val()),e.append("immagine",$("#immagine")[0].files[0]),e.append("immagine-banner",$("#immagine-banner")[0].files[0]),"0"==a)e.append("nuovaMacro","1"),$.ajax({type:"POST",data:e,url:"php/macroattivita.php",contentType:!1,processData:!1,async:!0,success:function(t){try{t=JSON.parse(t),e.append("idMacro",t.idMacro),1==t.stato?(generaAlert("green","Successo",t.messaggio),$("#finestra-macro").fadeOut("Slow"),$.ajax({url:"pannello_admin.php",data:e,processData:!1,contentType:!1,type:"POST",success:function(t){togliEventiMacroAttivita(),$("#act-manager").append(t),sbloccaScroll(),aggiungiEventiMacroAttivita(),$("#finestra-macro form")[0].reset()}})):generaAlert("red","Errore",t.messaggio)}catch(t){console.error(t),generaAlertErroreGenerico()}}});else{var i=$("#finestra-macro input[type=submit]").attr("data-fun");e.append("idMacro",i),$.ajax({type:"POST",data:e,url:"php/macroattivita.php",contentType:!1,processData:!1,async:!0,success:function(t){try{1==(t=JSON.parse(t)).stato?(generaAlert("green","Successo",t.messaggio),$("span[data-target='"+i+"']").prev().text(e.get("nome-macro")),$("#finestra-macro").fadeOut("slow",function(){sbloccaScroll(),$("#finestra-macro form")[0].reset()})):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}}})}}}),$("#annulla-macro").on("click",function(t){t.preventDefault(),t.stopPropagation(),$("#label-dialog2").text("Nuova macroattività"),$("#finestra-macro").fadeOut("Slow",function(){pulisciErrori($("#finestra-macro").find(".alert.errore"),$("#finestra-macro").find("form")),$(this).find("input[type=text],textarea").val(""),sbloccaScroll()})}),$("#usr-manager .btn-cancella").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione dell'account? ",buttons:{Procedi:{btnClass:"btn-red",action:function(){eliminaAccount(a)}},Annulla:{}}})}),$("#usr-manager .btn-reimposta").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$("#"+a).children(".username").text();$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con il reset della password dell'account: "+e+"?",buttons:{Procedi:{btnClass:"btn-blue",action:function(){$.post("php/modifica_dati_utente.php",{IDUtente:a},function(t){try{1==(t=JSON.parse(t)).stato?generaAlert("green","Successo",t.messaggio):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})}),$("#scheda-QR").on("click",function(){$("#lettoreQR").show(),(scanner=new Instascan.Scanner({video:$("#videoQR")[0],backgroundScan:!1})).addListener("scan",function(t){t.match("^pr-")?($("#testoQR").val(t),convalidaPrenotazione($("#testoQR").val())):generaAlert("red","Errore","Codice QR inquadrato non inerente ad una prenotazione.")});try{Instascan.Camera.getCameras().then(function(t){t.length>0?scanner.start(t[0]).catch(function(t){generaAlert("red","Errore","La lettura dei codici QR via HTTP è supportata solo da Firefox o Edge. Assicurati di avere un browser compatibile o usa HTTPS per abilitare il supporto anche su Chrome")}):generaAlert("red","Errore","Nessuna fotocamera trovata. La lettura dei codici QR verrà quindi disabilitata")}).catch(function(t){generaAlert("red","Errore","Errore nell'inizializzazione del lettore QR. La lettura dei codici QR non sarà quindi possibile")})}catch(t){generaAlert("red","Errore","Errore nell'inizializzazione del lettore QR. La lettura dei codici QR non sarà quindi possibile")}bloccaScroll()}),$("#convalidaQR").on("submit",function(t){t.preventDefault(),t.stopPropagation(),$("#testoQR").val().match("^pr-")?convalidaPrenotazione($("#testoQR").val()):generaAlert("red","Errore","Codice prenotazione inserito non valido")}),$("#annulla-QR").on("click",function(t){t.preventDefault(),t.stopPropagation(),$("#lettoreQR").fadeOut("Slow",function(){scanner.stop(),sbloccaScroll()})}),$("#res-manager .btn-cancella").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione della prenotazione ? ",buttons:{Procedi:{btnClass:"btn-red",action:function(){eliminaPrenotazione(a)}},Annulla:{}}})}),$(".pay").click(function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$(this),i=$(this).parent().prev();$.post("pannello_admin.php",{confermaPagamento:"1",codicePrenotazione:a},function(t){try{if(1==(t=JSON.parse(t)).stato){generaAlert("green","Pagamento effettuato",t.messaggio);var a=e.parent();e.remove(),a.text("Pagamento effettuato"),i.text("Pagato")}else generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}),$("#imposta-data").asDatepicker(),aggiungiListenerBottoneDisponibilita(),$("#impostazione-giorno form").on("submit",function(t){t.preventDefault(),t.stopPropagation();var a=$("#impostazione-giorno .alert.errore"),e=$("#impostazione-giorno form");if(pulisciErrori(a,e),0==$("#nPosti").val().trim().length)notificaErrore($("#Posti"),"Numero posti obbligatorio",a,e);else if("50"==$("#nPosti").val())notificaErrore($("#nPosti"),"Non puoi selezionare un numero posti uguale al valore di <span lang='en'>default</span>",a,e);else{var i=$("#imposta-data").val(),o=$("#nPosti").val();$("#"+i.replace(/\//g,"")).length&&notificaErrore($("#nPosti"),"Disponibilità per la data selezionata già modificata",a,e);var n=$("#impostazione-giorno form").serializeArray();n.push({name:"Disponibilita",value:"1"}),$.post("pannello_admin.php",n,function(t){try{"1"==(t=JSON.parse(t)).stato?(generaAlert("green","Succeso",t.messaggio),$("#tabella-giorni").append("<tr id='"+i.replace(/\//g,"")+"'><td>"+i+"</td><td>"+o+"</td><td><button data-target='"+i.replace(/\//g,"")+"'class='btn-cancella' title='Elimina'>X</button></td></tr>"),togliListenerBottoneDisponibilita(),aggiungiListenerBottoneDisponibilita()):notificaErrore($("#imposta-data"),t.messaggio,a,e)}catch(t){generaAlertErroreGenerico()}})}})});