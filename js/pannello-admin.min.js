var campiDati={},scanner=null;function aggiungiListenerBottoneDisponibilita(){$("#tabella-giorni button").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$("#"+a+" td").first().text(),i=$("#"+a);$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Ripristinare i posti disponibili a 50 per il giorno"+e+"?",buttons:{Procedi:{action:function(){$.post("pannello_admin.php",{Disponibilita:1,Elimina:1,data:e},function(t){try{"1"==(t=JSON.parse(t)).stato?(generaAlert("green","Successo",t.messaggio),i.remove()):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})})}function togliListenerBottoneDisponibilita(){$("#tabella-giorni button").off("click")}function eliminaRigaTabella(t){$("#"+t).slideUp("Slow",function(){$("#"+t).remove()})}function rispostaEliminiazionePrenotazione(t){eliminaRigaTabella(t)}function salvaDati(t){var a=$("#"+t).find("input[type=text], textarea,input[type=number]"),e={};return $(a).each(function(){e[$(this).attr("class")]=$(this).val()}),e}function validaFormModifica(t){var a=!0,e=$("#"+t),i=e.find(".alert.errore"),o=e.find("form"),r=e.find("textarea,input[type=text]");return pulisciErrori(i,o),$(r).each(function(){0==$(this).val().trim().length&&(notificaErrore($(this),"Il campo  "+$(this).attr("name")+"  non può essere vuoto.",i,o),a=!1)}),a}function aggiugngiEventiSchedeAttivita(){$("[data-modifica=false]").find(" input[type=number],input[type=text], textarea").attr("disabled","disabled"),$(".elimina-attivita").on("click",function(){var t=$(this).attr("data-target");$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione dell'attività? Tutte le prenotazioni relative a questa attività verranno eliminate.",buttons:{Procedi:{btnClass:"btn-red",action:function(){$.post("php/modifica_attivita.php",{eliminaAttivita:1,idAttivita:t},function(a){try{"1"==(a=JSON.parse(a)).stato?(generaAlert("green","Successo",a.messaggio),sistemaSchede(t),$("[data-attivita='"+t.replace("attivita-","")+"']").remove()):generaAlert("red","Errore",a.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})}),$(".schede .modifica").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");$("#"+a).attr("data-modifica","true"),abilitaModicaScheda(a),campiDati[a]=salvaDati(a)}),$(".schede .bottone-annulla").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).parent().parent(),e=a.parent().find(".alert.errore");pulisciErrori(e,a);var i=$(this).attr("data-target");$("#"+i).attr("data-modifica","false"),$("#nome-"+i).val(campiDati[i]["nome-attivita"]),$("#descrizione-"+i).val(campiDati[i].descrizione),$("#prezzo-"+i).val(""+campiDati[i].prezzo),disabilitaModificaScheda(i)}),$(".salva-dati").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=!0,i=$(this).parent().parent().prev(".alert.errore"),o=$(this).parent().parent(),r=$("#nome-"+a);if(pulisciErrori(i,o),r.val().trim().length<5&&(e=!1,notificaErrore(r,"Il nome dell'attività deve essere almeno di 5 caratteri.",i,o)),$("#descrizione-"+a).val().trim().length<5&&(e=!1,notificaErrore($("descrizione-"+a),"La descrizione dell'attività deve essere almeno di 5 caratteri.",i,o)),($("#prezzo-"+a).val()<=0||0==$("#prezzo-"+a).val().trim().length)&&(e=!1,notificaErrore($("#prezzo"+a),"Il prezzo deve essere positivo",i,o)),1==e&&validaFormModifica(a)){var n=$("#"+a).find("form").serializeArray();n.push({name:"idAttivita",value:a}),$.post("php/modifica_attivita.php",n,function(t){try{1==(t=JSON.parse(t)).stato?(campiDati[a]=salvaDati(a),generaAlert("green","Successo",t.messaggio),disabilitaModificaScheda(a),$("#"+a+" h2").text(n[0].value)):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}})}function abilitaModicaScheda(t){$("#"+t).find("textarea,input[type=text],input[type=number]").removeAttr("disabled"),$("#"+t+" .salva-dati").show(),$("#"+t+" .bottone-annulla").show(),$("#"+t+" .modifica").hide(),$("#"+t+" .nome-attivita").focus()}function disabilitaModificaScheda(t){$("#"+t).find("textarea,input[type=text],input[type=number]").attr("disabled","disabled"),$("#"+t+" .salva-dati").hide(),$("#"+t+" .bottone-annulla").hide(),$("#"+t+" .modifica").show()}function togliEventiSchedeAttivita(){$(".elimina-attivita").off("click"),$(".salva-dati").off("click"),$(".schede .modifica").off("click"),$(".schede .bottone-annulla").off("click")}function fadeDialogoNuovaAttivita(){$("#nuova-scheda-attivita").fadeOut("Slow",function(){$("#nuova-attivita").find("input[type=text],textarea,input[type=number]").val(""),$("#nuova-attivita h2 span").remove(),sbloccaScroll()})}function aggiungiEventiMacroAttivita(){$(".btn-nuova-attivita").on("click",function(){var t=$(this).attr("data-info"),a=$(this).attr("data-target");$("#nuova-attivita h2").prepend("<span>"+t+" - </span>"),$("#nuova-attivita input[type=submit]").attr("data-macro",a),$("#nuova-scheda-attivita").show(),bloccaScroll(),$("#nome").focus()}),$("#nuova-attivita button").on("click",function(t){t.preventDefault(),t.stopPropagation(),pulisciErrori($("#nuova-attivita").find(".alert.errore"),$("#nuova-attivita").find("form")),fadeDialogoNuovaAttivita()}),$("#nuova-attivita input[type=submit]").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=!0,e=($(this).next("div"),$(this).parent().parent().prev(".alert.errore")),i=$(this).parent().parent();if(pulisciErrori(e,i),$("#nome").val().trim().length<5&&(a=!1,notificaErrore($("#nome"),"Il nome dell'attività deve essere almeno di 5 caratteri.",e,i)),$("#descrizione").val().trim().length<5&&(a=!1,notificaErrore($("#descrizione"),"La descrizione dell'attività deve essere almeno di 5 caratteri.",e,i)),($("#prezzo").val()<=0||0==$("#prezzo").val().trim().length)&&(a=!1,notificaErrore($("#prezzo"),"Il prezzo deve essere positivo",e,i)),1==a&&validaFormModifica("nuova-attivita")){var o=$(this).attr("data-macro"),r=$("#nuova-attivita form").serializeArray();r.push({name:"nuovaAttivita",value:"true"},{name:"idMacro",value:o}),$.post("php/modifica_attivita.php",r,function(t){try{if(1==(t=JSON.parse(t)).stato){var a=$("#gruppo-macro-"+t.idMacro+" .scheda-wrapper").length%2,e="";e=0==a?"pari":"dispari",$.alert({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,type:"green",title:"Successo",content:t.messaggio,buttons:{Ok:{action:function(){$.post("pannello_admin.php",{nuovaScheda:1,Classe:e,Codice:t.CodiceAtt},function(a){$(a).insertBefore($("#gruppo-macro-"+t.idMacro+" .inserimento-scheda")),togliEventiSchedeAttivita(),fadeDialogoNuovaAttivita(),aggiugngiEventiSchedeAttivita()})}}}})}else t.hasOwnProperty("Tipo")?notificaErrore($("#nuova-attivita #nome"),t.messaggio,$("#nuova-attivita .alert.errore"),$("#nuova-attivita")):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}}),$(".mod-macro").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).parent().attr("data-target"),e=$(this).parent().prev().text(),i=$(".descrizione-macro-nascosta[data-target='"+a+"']").text();$("#label-dialog2").text(e+" - Modifica"),$("#nome-macro").val(e),$("#descrizione-macro").val($("<textarea/>").html(i).text()),$("#finestra-macro").show(),bloccaScroll(),$("#finestra-macro input[type=submit]").attr("data-fun",a)}),$(".canc-macro").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).parent().attr("data-target"),e=$(this).parent().parent();$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione della macroattività? Tutte le attività relative ad essa verrannò eliminate e conseguentemente verranno eliminate le prenotazioni di queste ultime.",buttons:{Procedi:{btnClass:"btn-red",action:function(){$.post("php/macroattivita.php",{idMacro:a,eliminaMacro:1},function(t){try{if("1"==(t=JSON.parse(t)).stato)generaAlert("green","Successo",t.messaggio),$("#gruppo-"+a).find("div.schede-attivita").each(function(){$("[data-attivita='"+$(this).attr("id").replace("attivita-","")+"']").remove()}),$("#gruppo-"+a).remove(),e.next().remove(),e.remove();else generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})})}function togliEventiMacroAttivita(){$(".btn-nuova-attivita").off("click"),$("#nuova-attivita button").off("click"),$("#nuova-attivita input[type=submit]").off("click"),$(".mod-macro").off("click"),$(".canc-macro").off("click")}function reinizializzaEventiPagamento(){$(".pay,.revoke-pay").off("click"),$(".pay").click(function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$(this),i=$(this).parent().prev();$.post("pannello_admin.php",{confermaPagamento:"1",codicePrenotazione:a},function(t){try{1==(t=JSON.parse(t)).stato?(generaAlert("green","Pagamento effettuato",t.messaggio),i.text("Pagato"),e.text("Revoca pagamento"),e.removeClass("pay"),e.addClass("revoke-pay"),reinizializzaEventiPagamento()):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}),$(".revoke-pay").click(function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$(this),i=$(this).parent().prev();$.post("pannello_admin.php",{confermaPagamento:"0",codicePrenotazione:a},function(t){try{1==(t=JSON.parse(t)).stato?(generaAlert("green","Pagamento revocato",t.messaggio),e.text("Conferma pagamento"),i.text("Non Pagato"),e.removeClass("revoke-pay"),e.addClass("pay"),reinizializzaEventiPagamento()):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})})}function bloccaScroll(){$("body").css({overflow:"hidden"})}function sbloccaScroll(){$("body").css({"overflow-y":"scroll"})}function convalidaPrenotazione(t){$.post("pannello_admin.php",{convalidaPrenotazione:!0,prenotazione:t},function(a){try{var e=JSON.parse(a);1==e.stato?(generaAlert("green","Successo",e.messaggio),$("tr#"+t.split("-")[1]+" > td.stato").text("Confermata"),$("form#convalidaQR")[0].reset()):generaAlert("red","Errore",e.messaggio)}catch(t){generaAlertErroreGenerico()}})}$(function(){aggiungiEventiMacroAttivita(),aggiugngiEventiSchedeAttivita(),$("#crea-macro").on("click",function(){$("#label-dialog2").text("Nuova macroattività"),$("#finestra-macro").show(),bloccaScroll(),$("#finestra-macro input[type=submit]").attr("data-fun","0")}),$("#finestra-macro input[type=submit]").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-fun"),e=$(this).parent().parent().prev(".alert.errore"),i=$(this).parent().parent();pulisciErrori(e,i);var o=!0;if($("#nome-macro").val().trim().length<5&&(o=!1,notificaErrore($("#nome-macro"),"Il nome della macroattività deve essere almeno di 5 caratteri.",e,i)),$("#descrizione-macro").val().trim().length<5&&(o=!1,notificaErrore($("#descrizione-macro"),"La descrizione della macroattività deve essere almeno di 5 caratteri.",e,i)),1==o&&validaFormModifica("finestra-macro")){$("#finestra-macro form");var r=new FormData;if(r.append("nome-macro",$("#nome-macro").val()),r.append("descrizione-macro",$("#descrizione-macro").val()),r.append("immagine",$("#immagine")[0].files[0]),r.append("immagine-banner",$("#immagine-banner")[0].files[0]),"0"==a)r.append("nuovaMacro","1"),$.ajax({type:"POST",data:r,url:"php/macroattivita.php",contentType:!1,processData:!1,async:!0,success:function(t){try{t=JSON.parse(t),r.append("idMacro",t.idMacro),1==t.stato?(generaAlert("green","Successo",t.messaggio),$("#finestra-macro").fadeOut("Slow"),$.ajax({url:"pannello_admin.php",data:r,processData:!1,contentType:!1,type:"POST",success:function(t){togliEventiMacroAttivita(),$("#act-manager").append(t),sbloccaScroll(),aggiungiEventiMacroAttivita(),$("#finestra-macro form")[0].reset()}})):generaAlert("red","Errore",t.messaggio)}catch(t){console.error(t),generaAlertErroreGenerico()}}});else{var n=$("#finestra-macro input[type=submit]").attr("data-fun");r.append("idMacro",n),$.ajax({type:"POST",data:r,url:"php/macroattivita.php",contentType:!1,processData:!1,async:!0,success:function(t){try{1==(t=JSON.parse(t)).stato?(generaAlert("green","Successo",t.messaggio),$("span[data-target='"+n+"']").prev().text(r.get("nome-macro")),$(".descrizione-macro-nascosta[data-target='"+n+"']").text(r.get("descrizione-macro")),$("#finestra-macro").fadeOut("slow",function(){sbloccaScroll(),$("#finestra-macro form")[0].reset()})):generaAlert("red","Errore",t.messaggio)}catch(t){console.log(t),generaAlertErroreGenerico()}}})}}}),$("#annulla-macro").on("click",function(t){t.preventDefault(),t.stopPropagation(),$("#label-dialog2").text("Nuova macroattività"),$("#finestra-macro").fadeOut("Slow",function(){pulisciErrori($("#finestra-macro").find(".alert.errore"),$("#finestra-macro").find("form")),$(this).find("input[type=text],textarea").val(""),sbloccaScroll()})}),$("#usr-manager .btn-cancella").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione dell'account? ",buttons:{Procedi:{btnClass:"btn-red",action:function(){eliminaAccount(a)}},Annulla:{}}})}),$("#usr-manager .btn-reimposta").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target"),e=$("#"+a).children(".username").text();$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con il reset della password dell'account: "+e+"?",buttons:{Procedi:{btnClass:"btn-blue",action:function(){$.post("php/modifica_dati_utente.php",{IDUtente:a},function(t){try{1==(t=JSON.parse(t)).stato?generaAlert("green","Successo",t.messaggio):generaAlert("red","Errore",t.messaggio)}catch(t){generaAlertErroreGenerico()}})}},Annulla:{}}})}),$("#convalidaQR").on("submit",function(t){t.preventDefault(),t.stopPropagation(),$("#testoQR").val().match("^pr-")?convalidaPrenotazione($("#testoQR").val()):generaAlert("red","Errore","Codice prenotazione inserito non valido.")}),$("#annulla-QR").on("click",function(t){t.preventDefault(),t.stopPropagation(),$("#lettoreQR").fadeOut("Slow",function(){scanner.stop(),sbloccaScroll()})}),$("#res-manager .btn-cancella").on("click",function(t){t.preventDefault(),t.stopPropagation();var a=$(this).attr("data-target");$.confirm({boxWidth:calcolaDimensioneDialog(),useBootstrap:!1,title:"Conferma",content:"Procedere con l'eliminazione della prenotazione? ",buttons:{Procedi:{btnClass:"btn-red",action:function(){eliminaPrenotazione(a)}},Annulla:{}}})}),reinizializzaEventiPagamento(),$("#imposta-data").asDatepicker(),aggiungiListenerBottoneDisponibilita(),$("#impostazione-giorno form").on("submit",function(t){t.preventDefault(),t.stopPropagation();var a=$("#impostazione-giorno .alert.errore"),e=$("#impostazione-giorno form");if(pulisciErrori(a,e),0==$("#nPosti").val().trim().length)notificaErrore($("#Posti"),"Numero posti obbligatorio",a,e);else if("50"==$("#nPosti").val())notificaErrore($("#nPosti"),"Non puoi selezionare un numero posti uguale al valore di <span lang='en'>default</span>",a,e);else{var i=$("#imposta-data").val(),o=$("#nPosti").val();$("#"+i.replace(/\//g,"")).length&&notificaErrore($("#nPosti"),"Disponibilità per la data selezionata già modificata.",a,e);var r=$("#impostazione-giorno form").serializeArray();r.push({name:"Disponibilita",value:"1"}),$.post("pannello_admin.php",r,function(t){try{"1"==(t=JSON.parse(t)).stato?(generaAlert("green","Succeso",t.messaggio),$("#tabella-giorni").append("<tr id='"+i.replace(/\//g,"")+"'><td>"+i+"</td><td>"+o+"</td><td><button data-target='"+i.replace(/\//g,"")+"'class='btn-cancella' title='Elimina'>X</button></td></tr>"),togliListenerBottoneDisponibilita(),aggiungiListenerBottoneDisponibilita()):notificaErrore($("#imposta-data"),t.messaggio,a,e)}catch(t){generaAlertErroreGenerico()}})}})});